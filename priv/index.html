<!DOCTYPE html>
<html>
<head>
 <meta charset=utf-8 />
 <title>Application Statistics</title>
 <style>
   * { margin: 0 auto; }
   body { font-family: Helvetica, Arial, Sans-Serif; }
   div#wrapper { width: 900px; margin: 20px auto 0 auto; }
   header#welcome h1 { font-size: 7em; display: block;
     padding-bottom: 10px; border-bottom: 1px solid rgb(100,100,100); }
   div#top_running { display: block; width: 100%; height: 10px; }
   body.up .s_down { display: none !important; }
   body.down .s_up { display: none !important; }
   body.loading div#wrapper { display: none; }
   .s_loading { display: none; }
   p#update {float:left;}
   pre#stats_last_updated {float:left; margin : 3px;}
   h1.s_loading { font-size: 8em; text-align: center; }
   body.loading .s_loading { display: block; }
   body.up div#top_running { background: #108A47; }
   body.down div#top_running { background: #992D2E; }
   body.up header#welcome h1 span { color: #108A47; }
   body.down header#welcome h1 span { color: #992D2E; }
   section { padding: 10px; }
   section#fix_it { padding-bottom: 15px; }
   section#fix_it h1 { margin-bottom: 1px; }
   section#stats { display: block; }
   section#refresh_rate { display: block; text-align: right; padding-bottom: 0px; }
   section.stat_box { border-radius: 10px; min-height: 150px; -moz-border-radius: 10px; -webkit-border-radius: 10px;
      width: 400px; border-radius: 10px; display: inline-block; vertical-align: top; margin: 5px; background: rgb(220,220,220); }
   section.stat_box header { border-bottom: 1px solid black; margin-bottom: 5px; }
   section.stat_box header h3 { float: right; font-size: .8em; }
   section.stat_box pre { display: inline-block; margin-left: 5px; float:right}
   footer { clear: both; display: block; border-top: 1px solid rgb(100,100,100); padding-top: 5px; }
   footer p { text-align: right; padding-top: 5px; font-size: 0.8em; }
 </style>
</head>
<body class="loading">
  <div id="top_running">&nbsp;</div>
  <h1 class="s_loading">Loading</h1>
  <div id="wrapper">
    <header id="welcome">
      <h1>application is <span class="s_up">up</span><span class="s_down">down</span></h1>
    </header>
    </section>
    <section id="fix_it" class="s_down">
      <h1>What does this mean?</h1>
      <p>While this page was trying to fetch new data, the application did not respond.</p>
    </section>
    <section id="refresh_rate" class="s_up">
      <p>Refresh every
        <select id="interval_selector">
          <option value="1000">1</option>
          <option value="3000">3</option>
          <option value="5000">5</option>
        </select>
        second/s
      </p>
    </section>
      <section class="stat_box" id="stats">
        <header>
          <h1>Statistics</h1>
        </header>
          <p>
          </p>
      </section>
    </section>
    <footer>
      <p>Generated by Erlstats web Server</p>
    </footer>
  </div>
  <script type="application/javascript">  
  "use strict";
  var EventBus = function() {
    var events = []
    var _on = function(eventName, callback) {
      if (!events.some(function(e) {
          return e.name == eventName; })) {
            var new_event = {
              name: eventName,
              cb: callback
            };
            events.push(new_event);
            return [eventName, callback];
      } else {
        return -1;
      }
    };
    var _emit = function(eventName, args) {
      var match = events.filter(function(e) {
        return e.name == eventName;
      });
      match.forEach(function(m) {
        m.cb(args);
      });
    };

    return {
      on: _on,
      emit: _emit
    }
  }();

  var View = function() {
    var attributes = {
      stats: {
      },
   }

    var _updateObject = function(name, value) {
    if (typeof(attributes[name]) == 'object' && attributes[name] != null){
      var a_att = Object.keys(attributes[name]);
      a_att.forEach(function(a) {
        if (typeof(attributes[a]) == Object) {
          console.error("Can't update deep objects");
        } else {
          attributes[a] = value[a];
          Erlstats.UpdateField(name, a, attributes[a]);
        }
      });
    } else if(value.length > 0 ){
          Erlstats.UpdateField("stats",name,value);
      }
    };

    return {
      update: function(name, value) {
        if ((typeof(value) == 'object' || typeof(value) == 'string') && value != null) {
            _updateObject(name, value);
        }
      }
    }
  }();

  EventBus.on('field_updated', function(d) {
    Erlstats.UpdateField(d[0], d[1], d[2]);
  });
  
  EventBus.on('system_down', function() {
    Erlstats.showDown();
  });
  
  EventBus.on('system_up', function() {
    Erlstats.showUp();
  });
  
  var Erlstats = {
    systemUp: null,
    showDown: function() {
      if (Erlstats.systemUp || Erlstats.systemUp == null) {
        window.document.body.setAttribute("class","down");
      }
    },
    showUp: function() {
      if (!Erlstats.systemUp || Erlstats.systemUp == null) {
        window.document.body.setAttribute("class","up");
      }
    },
    doXHR: function(url, verb, callback) {
      var request = new XMLHttpRequest();
      request.open("GET", url);
      request.onreadystatechange = function(state) {
        if (request.readyState == 4) {
          EventBus.emit('system_up');
          callback(request.responseText);
        }
      };
      request.onerror = function() {
        EventBus.emit('system_down');
      };
      request.send(null);
    },
    UpdateField: function(parent, field, value) {
    },
    IntervalId: 0
  };

  EventBus.on('incoming_data', function(d) {
    var attrs = Object.keys(d),
        l_attrs = attrs.length;
    attrs.forEach(function(a) {
      View.update(a, d[a]);
    });
  });

  var SystemSettings = {
    update: function() {
      Erlstats.doXHR("all/json", "GET", function(data) {
        var jData;
        try {
          jData = JSON.parse(data);
          EventBus.emit('incoming_data', jData);
        } catch(err) {
          console.log(err);
        }
      });
    },
    SetTimer: function(timeout) {
      if (Erlstats.IntervalId != 0) {
        clearInterval(Kodi.IntervalId);
      }
      Erlstats.IntervalId = setInterval(function() {
        SystemSettings.update();
      }, timeout)
    }
  };
  
  var selector = document.getElementById("interval_selector");
  
  selector.onchange = function(e) {
    SystemSettings.SetTimer(e.target.value);
  }; 
  
  SystemSettings.update();
  
  SystemSettings.SetTimer(1000);
  
  if (!("keys" in Object)) {
    Object.prototype.keys = function(self) {
      var retval = [];
      for (var i in self) {
        retval.push(i);
      }
      return retval;
    }
  }
  if (!("forEach" in Object)) {
    Object.prototype.forEach = function(f) {
      var l_this = this.length;
      for (var i = l_this - 1; i >= 0; i--) {
        f(this[i]);
      };
    };
  }

  function formatNumber(num,dec,thou,pnt,curr1,curr2,n1,n2)
  {
    var x = Math.round(num * Math.pow(10,dec));
    if (x >= 0) n1=n2='';
    var y = (''+Math.abs(x)).split('');
    var z = y.length - dec;
    if (z<0) z--;
    for(var i = z; i < 0; i++) y.unshift('0');
    if (z<0) z = 1;
    y.splice(z, 0, pnt);
    if(y[0] == pnt) y.unshift('0');
    while (z > 3) {
      z-=3;
      y.splice(z,0,thou);
    }
    var r = curr1+n1+y.join('')+n2+curr2;
    return r;
  }
  </script>
</body>
</html>
